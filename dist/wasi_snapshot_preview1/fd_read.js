import { parseArray } from "../_private/iovec.js";
import { EBADF, ESUCCESS } from "../errno.js";
import { writeSizeT } from "../util/write-sizet.js";
const FdReadInfoSymbol = Symbol();
export class FileDescriptorReadEvent extends CustomEvent {
    constructor(fileDescriptor, data) {
        super("fd_read", {
            bubbles: false,
            cancelable: true,
            detail: {
                fileDescriptor,
                data
            }
        });
    }
}
/** POSIX readv */
export function fd_read(fd, iov, iovcnt, pnum) {
    let nWritten = 0;
    const buffers = parseArray(this, iov, iovcnt);
    const this2 = (this[FdReadInfoSymbol] ??= { data: [] });
    const event = new FileDescriptorReadEvent(fd, this2.data);
    if (this.dispatchEvent(event)) {
        if (fd === 0) {
            if (event.detail.data.length == 0) {
                // Default behavior for stdin--use window.prompt.
                // TODO: WASM promises when those are available
                console.assert(event.detail.data.length == 0);
                const str = (window.prompt() ?? "") + "\n";
                event.detail.data.push(str);
            }
        }
        else {
            return EBADF;
        }
    }
    // Write the user-provided data to the buffer
    let outBuffIndex = 0;
    let inBuffIndex = 0;
    let outBuff = buffers[outBuffIndex].uint8;
    let inBuff = event.detail.data[inBuffIndex];
    while (true) {
        if (typeof inBuff == "string")
            inBuff = new TextEncoder().encode(inBuff);
        if (outBuff == null || inBuff == null)
            break;
        // Write what we can from inBuff to outBuff.
        const lengthRemainingToWrite = inBuff.byteLength;
        const lengthAvailableToWrite = outBuff.byteLength;
        const lengthToWrite = Math.min(lengthAvailableToWrite, lengthRemainingToWrite);
        outBuff.set(inBuff.subarray(0, lengthToWrite));
        // Now "discard" what we wrote
        // (this doesn't actually do any heavy memory moves or anything,
        // it's just creating new views over the same `ArrayBuffer`s).
        inBuff = inBuff.subarray(lengthToWrite);
        outBuff = outBuff.subarray(lengthToWrite);
        // Now see where we're at with each buffer.
        // If we ran out of input data, move to the next input buffer.
        if (lengthRemainingToWrite < lengthAvailableToWrite) {
            ++inBuffIndex;
            inBuff = event.detail.data[inBuffIndex];
        }
        // If we ran out of output space, move to the next output buffer.
        if (lengthAvailableToWrite < lengthRemainingToWrite) {
            ++outBuffIndex;
            outBuff = buffers[outBuffIndex]?.uint8;
        }
        nWritten += lengthToWrite;
    }
    const d = [];
    if (inBuff && inBuff.byteLength)
        d.push(inBuff);
    if (event.detail.data.length > 0)
        d.push(...event.detail.data.slice(inBuffIndex + 1));
    this2.data = d;
    writeSizeT(this, pnum, nWritten);
    return ESUCCESS;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmRfcmVhZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy93YXNpX3NuYXBzaG90X3ByZXZpZXcxL2ZkX3JlYWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQTRCcEQsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLEVBQUUsQ0FBQztBQVFsQyxNQUFNLE9BQU8sdUJBQXdCLFNBQVEsV0FBMEM7SUFHbkYsWUFBWSxjQUFzQixFQUFFLElBQTZCO1FBQzdELEtBQUssQ0FBQyxTQUFTLEVBQUU7WUFDYixPQUFPLEVBQUUsS0FBSztZQUNkLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLE1BQU0sRUFBRTtnQkFDSixjQUFjO2dCQUNkLElBQUk7YUFDUDtTQUNKLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQUVELGtCQUFrQjtBQUNsQixNQUFNLFVBQVUsT0FBTyxDQUF5QixFQUFrQixFQUFFLEdBQVcsRUFBRSxNQUFjLEVBQUUsSUFBWTtJQUN6RyxJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUM7SUFDakIsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFFOUMsTUFBTSxLQUFLLEdBQUcsQ0FBRSxJQUFrQyxDQUFDLGdCQUFnQixDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUV2RixNQUFNLEtBQUssR0FBRyxJQUFJLHVCQUF1QixDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUQsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDNUIsSUFB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RWYsVUFBVSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFFakMsT0FBTyxRQUFRLENBQUM7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHBhcnNlQXJyYXkgfSBmcm9tIFwiLi4vX3ByaXZhdGUvaW92ZWMuanNcIjtcclxuaW1wb3J0IHsgRUJBREYsIEVTVUNDRVNTIH0gZnJvbSBcIi4uL2Vycm5vLmpzXCI7XHJcbmltcG9ydCB0eXBlIHsgRmlsZURlc2NyaXB0b3IgfSBmcm9tIFwiLi4vdHlwZXMuanNcIjtcclxuaW1wb3J0IHsgd3JpdGVTaXplVCB9IGZyb20gXCIuLi91dGlsL3dyaXRlLXNpemV0LmpzXCI7XHJcbmltcG9ydCB0eXBlIHsgSW5zdGFudGlhdGVkV2FzbSB9IGZyb20gXCIuLi93YXNtLmpzXCI7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEZpbGVEZXNjcmlwdG9yUmVhZEV2ZW50RGV0YWlsIHtcclxuICAgIC8qKlxyXG4gICAgICogVGhlIFtmaWxlIGRlc2NyaXB0b3JdKGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0ZpbGVfZGVzY3JpcHRvciksIGEgMC1pbmRleGVkIG51bWJlciBkZXNjcmliaW5nIHdoZXJlIHRoZSBkYXRhIGlzIGdvaW5nIHRvL2NvbWluZyBmcm9tLlxyXG4gICAgICogXHJcbiAgICAgKiBJdCdzIG1vcmUtb3ItbGVzcyBbdW5pdmVyc2FsbHkgZXhwZWN0ZWRdKGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1N0YW5kYXJkX3N0cmVhbSkgdGhhdCAwIGlzIGZvciBpbnB1dCwgMSBmb3Igb3V0cHV0LCBhbmQgMiBmb3IgZXJyb3JzLFxyXG4gICAgICogc28geW91IGNhbiBtYXAgMSB0byBgY29uc29sZS5sb2dgIGFuZCAyIHRvIGBjb25zb2xlLmVycm9yYCwgd2l0aCBvdGhlcnMgaGFuZGxlZCB3aXRoIHRoZSB2YXJpb3VzIGZpbGUtb3BlbmluZyBjYWxscy4gXHJcbiAgICAgKi9cclxuICAgIHJlYWRvbmx5IGZpbGVEZXNjcmlwdG9yOiBudW1iZXI7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBUaGUgZGF0YSB5b3Ugd2FudCB0byB3cml0ZSB0byB0aGlzIGZpbGVEZXNjcmlwdG9yIGlmIGBwcmV2ZW50RGVmYXVsdGAgaXMgY2FsbGVkLlxyXG4gICAgICogXHJcbiAgICAgKiBJZiBpdCBpcyBsb25nZXIgdGhhbiB0aGUgYnVmZmVycyBhbGxvdywgdGhlbiB0aGUgbmV4dCB0aW1lXHJcbiAgICAgKiB0aGlzIGV2ZW50IGlzIGRpc3BhdGNoZWQsIGBkYXRhYCB3aWxsIGJlIHByZS1maWxsZWQgd2l0aFxyXG4gICAgICogd2hhdGV2ZXIgd2FzIGxlZnRvdmVyLiBZb3UgY2FuIHRoZW4gYWRkIG1vcmUgaWYgeW91IHdhbnQuXHJcbiAgICAgKiBcclxuICAgICAqIE9uY2UgYWxsIG9mIGBkYXRhYCBoYXMgYmVlbiByZWFkIChrZWVwaW5nIGluIG1pbmQgaG93IG5ld2xpbmVzXHJcbiAgICAgKiBjYW4gXCJwYXVzZVwiIHRoZSByZWFkaW5nIG9mIGBkYXRhYCB1bnRpbCBzb21lIHRpbWUgaW4gdGhlIGZ1dHVyZVxyXG4gICAgICogYW5kIG90aGVyIGZvcm1hdHRlZCBpbnB1dCBxdWlya3MpLCBpbmNsdWRpbmcgaWYgbm8gZGF0YSBpcyBldmVyXHJcbiAgICAgKiBhZGRlZCBpbiB0aGUgZmlyc3QgcGxhY2UsIGl0J3MgdW5kZXJzdG9vZCB0byBiZSBFT0YuXHJcbiAgICAgKi9cclxuICAgIHJlYWRvbmx5IGRhdGE6IChVaW50OEFycmF5IHwgc3RyaW5nKVtdO1xyXG59XHJcblxyXG5cclxuY29uc3QgRmRSZWFkSW5mb1N5bWJvbCA9IFN5bWJvbCgpO1xyXG5pbnRlcmZhY2UgRmRSZWFkSW5mbyB7XHJcbiAgICBkYXRhOiAoVWludDhBcnJheSB8IHN0cmluZylbXTtcclxufVxyXG5pbnRlcmZhY2UgV2l0aEZkUmVhZEluZm8ge1xyXG4gICAgW0ZkUmVhZEluZm9TeW1ib2xdOiBGZFJlYWRJbmZvO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgRmlsZURlc2NyaXB0b3JSZWFkRXZlbnQgZXh0ZW5kcyBDdXN0b21FdmVudDxGaWxlRGVzY3JpcHRvclJlYWRFdmVudERldGFpbD4ge1xyXG5cclxuXHJcbiAgICBjb25zdHJ1Y3RvcihmaWxlRGVzY3JpcHRvcjogbnVtYmVyLCBkYXRhOiAoVWludDhBcnJheSB8IHN0cmluZylbXSkge1xyXG4gICAgICAgIHN1cGVyKFwiZmRfcmVhZFwiLCB7XHJcbiAgICAgICAgICAgIGJ1YmJsZXM6IGZhbHNlLFxyXG4gICAgICAgICAgICBjYW5jZWxhYmxlOiB0cnVlLFxyXG4gICAgICAgICAgICBkZXRhaWw6IHtcclxuICAgICAgICAgICAgICAgIGZpbGVEZXNjcmlwdG9yLFxyXG4gICAgICAgICAgICAgICAgZGF0YVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKiBQT1NJWCByZWFkdiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZmRfcmVhZCh0aGlzOiBJbnN0YW50aWF0ZWRXYXNtLCBmZDogRmlsZURlc2NyaXB0b3IsIGlvdjogbnVtYmVyLCBpb3ZjbnQ6IG51bWJlciwgcG51bTogbnVtYmVyKTogbnVtYmVyIHtcclxuICAgIGxldCBuV3JpdHRlbiA9IDA7XHJcbiAgICBjb25zdCBidWZmZXJzID0gcGFyc2VBcnJheSh0aGlzLCBpb3YsIGlvdmNudCk7XHJcblxyXG4gICAgY29uc3QgdGhpczIgPSAoKHRoaXMgYXMgdW5rbm93biBhcyBXaXRoRmRSZWFkSW5mbylbRmRSZWFkSW5mb1N5bWJvbF0gPz89IHsgZGF0YTogW10gfSk7XHJcblxyXG4gICAgY29uc3QgZXZlbnQgPSBuZXcgRmlsZURlc2NyaXB0b3JSZWFkRXZlbnQoZmQsIHRoaXMyLmRhdGEpO1xyXG4gICAgaWYgKHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCkpIHtcclxuICAgICAgICBpZiAoZmQgPT09IDApIHtcclxuICAgICAgICAgICAgaWYgKGV2ZW50LmRldGFpbC5kYXRhLmxlbmd0aCA9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBEZWZhdWx0IGJlaGF2aW9yIGZvciBzdGRpbi0tdXNlIHdpbmRvdy5wcm9tcHQuXHJcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBXQVNNIHByb21pc2VzIHdoZW4gdGhvc2UgYXJlIGF2YWlsYWJsZVxyXG4gICAgICAgICAgICAgICAgY29uc29sZS5hc3NlcnQoZXZlbnQuZGV0YWlsLmRhdGEubGVuZ3RoID09IDApO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc3RyID0gKHdpbmRvdy5wcm9tcHQoKSA/PyBcIlwiKSArIFwiXFxuXCI7XHJcbiAgICAgICAgICAgICAgICBldmVudC5kZXRhaWwuZGF0YS5wdXNoKHN0cik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBFQkFERjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gV3JpdGUgdGhlIHVzZXItcHJvdmlkZWQgZGF0YSB0byB0aGUgYnVmZmVyXHJcbiAgICBsZXQgb3V0QnVmZkluZGV4ID0gMDtcclxuICAgIGxldCBpbkJ1ZmZJbmRleCA9IDA7XHJcbiAgICBsZXQgb3V0QnVmZjogVWludDhBcnJheSA9IGJ1ZmZlcnNbb3V0QnVmZkluZGV4XS51aW50ODtcclxuICAgIGxldCBpbkJ1ZmY6IFVpbnQ4QXJyYXkgfCBzdHJpbmcgPSBldmVudC5kZXRhaWwuZGF0YVtpbkJ1ZmZJbmRleF07XHJcblxyXG4gICAgd2hpbGUgKHRydWUpIHtcclxuXHJcbiAgICAgICAgaWYgKHR5cGVvZiBpbkJ1ZmYgPT0gXCJzdHJpbmdcIilcclxuICAgICAgICAgICAgaW5CdWZmID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKGluQnVmZik7XHJcblxyXG4gICAgICAgIGlmIChvdXRCdWZmID09IG51bGwgfHwgaW5CdWZmID09IG51bGwpXHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAvLyBXcml0ZSB3aGF0IHdlIGNhbiBmcm9tIGluQnVmZiB0byBvdXRCdWZmLlxyXG5cclxuICAgICAgICBjb25zdCBsZW5ndGhSZW1haW5pbmdUb1dyaXRlID0gaW5CdWZmLmJ5dGVMZW5ndGg7XHJcbiAgICAgICAgY29uc3QgbGVuZ3RoQXZhaWxhYmxlVG9Xcml0ZSA9IG91dEJ1ZmYuYnl0ZUxlbmd0aDtcclxuICAgICAgICBjb25zdCBsZW5ndGhUb1dyaXRlID0gTWF0aC5taW4obGVuZ3RoQXZhaWxhYmxlVG9Xcml0ZSwgbGVuZ3RoUmVtYWluaW5nVG9Xcml0ZSk7XHJcbiAgICAgICAgb3V0QnVmZi5zZXQoaW5CdWZmLnN1YmFycmF5KDAsIGxlbmd0aFRvV3JpdGUpKTtcclxuXHJcbiAgICAgICAgLy8gTm93IFwiZGlzY2FyZFwiIHdoYXQgd2Ugd3JvdGVcclxuICAgICAgICAvLyAodGhpcyBkb2Vzbid0IGFjdHVhbGx5IGRvIGFueSBoZWF2eSBtZW1vcnkgbW92ZXMgb3IgYW55dGhpbmcsXHJcbiAgICAgICAgLy8gaXQncyBqdXN0IGNyZWF0aW5nIG5ldyB2aWV3cyBvdmVyIHRoZSBzYW1lIGBBcnJheUJ1ZmZlcmBzKS5cclxuICAgICAgICBpbkJ1ZmYgPSBpbkJ1ZmYuc3ViYXJyYXkobGVuZ3RoVG9Xcml0ZSk7XHJcbiAgICAgICAgb3V0QnVmZiA9IG91dEJ1ZmYuc3ViYXJyYXkobGVuZ3RoVG9Xcml0ZSk7XHJcblxyXG4gICAgICAgIC8vIE5vdyBzZWUgd2hlcmUgd2UncmUgYXQgd2l0aCBlYWNoIGJ1ZmZlci5cclxuICAgICAgICAvLyBJZiB3ZSByYW4gb3V0IG9mIGlucHV0IGRhdGEsIG1vdmUgdG8gdGhlIG5leHQgaW5wdXQgYnVmZmVyLlxyXG4gICAgICAgIGlmIChsZW5ndGhSZW1haW5pbmdUb1dyaXRlIDwgbGVuZ3RoQXZhaWxhYmxlVG9Xcml0ZSkge1xyXG4gICAgICAgICAgICArK2luQnVmZkluZGV4O1xyXG4gICAgICAgICAgICBpbkJ1ZmYgPSBldmVudC5kZXRhaWwuZGF0YVtpbkJ1ZmZJbmRleF07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBJZiB3ZSByYW4gb3V0IG9mIG91dHB1dCBzcGFjZSwgbW92ZSB0byB0aGUgbmV4dCBvdXRwdXQgYnVmZmVyLlxyXG4gICAgICAgIGlmIChsZW5ndGhBdmFpbGFibGVUb1dyaXRlIDwgbGVuZ3RoUmVtYWluaW5nVG9Xcml0ZSkge1xyXG4gICAgICAgICAgICArK291dEJ1ZmZJbmRleDtcclxuICAgICAgICAgICAgb3V0QnVmZiA9IGJ1ZmZlcnNbb3V0QnVmZkluZGV4XT8udWludDg7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG5Xcml0dGVuICs9IGxlbmd0aFRvV3JpdGU7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZDogKHN0cmluZyB8IFVpbnQ4QXJyYXkpW10gPSBbXTtcclxuICAgIGlmIChpbkJ1ZmYgJiYgaW5CdWZmLmJ5dGVMZW5ndGgpXHJcbiAgICAgICAgZC5wdXNoKGluQnVmZik7XHJcbiAgICBpZiAoZXZlbnQuZGV0YWlsLmRhdGEubGVuZ3RoID4gMClcclxuICAgICAgICBkLnB1c2goLi4uZXZlbnQuZGV0YWlsLmRhdGEuc2xpY2UoaW5CdWZmSW5kZXggKyAxKSk7XHJcblxyXG4gICAgdGhpczIuZGF0YSA9IGQ7XHJcblxyXG4gICAgd3JpdGVTaXplVCh0aGlzLCBwbnVtLCBuV3JpdHRlbik7XHJcblxyXG4gICAgcmV0dXJuIEVTVUNDRVNTO1xyXG59XHJcbiJdfQ==