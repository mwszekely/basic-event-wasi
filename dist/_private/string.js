import { readUint16 } from "../util/read-uint16.js";
import { readUint32 } from "../util/read-uint32.js";
import { readUint8 } from "../util/read-uint8.js";
import { InstantiatedWasm } from "../wasm.js";
/**
 * TODO: Can't C++ identifiers include non-ASCII characters?
 * Why do all the type decoding functions use this?
 */
export function readLatin1String(impl, ptr) {
    let ret = "";
    let nextByte;
    while (nextByte = readUint8(impl, ptr++)) {
        ret += String.fromCharCode(nextByte);
    }
    return ret;
}
// Note: In Worklets, `TextDecoder` and `TextEncoder` need a polyfill.
let utf8Decoder = new TextDecoder("utf-8");
let utf16Decoder = new TextDecoder("utf-16le");
let utf8Encoder = new TextEncoder();
/**
 * Decodes a null-terminated UTF-8 string. If you know the length of the string, you can save time by using `utf8ToStringL` instead.
 *
 * @param impl
 * @param ptr
 * @returns
 */
export function utf8ToStringZ(impl, ptr) {
    const start = ptr;
    let end = start;
    while (readUint8(impl, end++) != 0)
        ;
    return utf8ToStringL(impl, start, end - start - 1);
}
export function utf16ToStringZ(impl, ptr) {
    const start = ptr;
    let end = start;
    while (readUint16(impl, end) != 0) {
        end += 2;
    }
    return utf16ToStringL(impl, start, end - start - 1);
}
export function utf32ToStringZ(impl, ptr) {
    const start = ptr;
    let end = start;
    while (readUint32(impl, end) != 0) {
        end += 4;
    }
    return utf32ToStringL(impl, start, end - start - 1);
}
export function utf8ToStringL(impl, ptr, byteCount) {
    return utf8Decoder.decode(new Uint8Array(impl.exports.memory.buffer, ptr, byteCount));
}
export function utf16ToStringL(impl, ptr, wcharCount) {
    return utf16Decoder.decode(new Uint8Array(impl.exports.memory.buffer, ptr, wcharCount * 2));
}
export function utf32ToStringL(impl, ptr, wcharCount) {
    const chars = (new Uint32Array(impl.exports.memory.buffer, ptr, wcharCount));
    let ret = "";
    for (let ch of chars) {
        ret += String.fromCharCode(ch);
    }
    return ret;
}
export function stringToUtf8(string) {
    return utf8Encoder.encode(string).buffer;
}
export function stringToUtf16(string) {
    let ret = new Uint16Array(new ArrayBuffer(string.length));
    for (let i = 0; i < ret.length; ++i) {
        ret[i] = string.charCodeAt(i);
    }
    return ret.buffer;
}
export function stringToUtf32(string) {
    let trueLength = 0;
    // The worst-case scenario is a string of all surrogate-pairs, so allocate that.
    // We'll shrink it to the actual size afterwards.
    let temp = new Uint32Array(new ArrayBuffer(string.length * 4 * 2));
    for (const ch of string) {
        temp[trueLength] = ch.codePointAt(0);
        ++trueLength;
    }
    return temp.buffer.slice(0, trueLength * 4);
}
/**
 * Used when sending strings from JS to WASM.
 *
 *
 * @param str
 * @returns
 */
export function lengthBytesUTF8(str) {
    let len = 0;
    for (let i = 0; i < str.length; ++i) {
        let c = str.codePointAt(i);
        if (c <= 0x7F)
            len++;
        else if (c <= 0x7FF)
            len += 2;
        else if (c <= 0x7FFF)
            len += 3;
        else {
            len += 4;
            ++i;
        }
    }
    return len;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL19wcml2YXRlL3N0cmluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDcEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3BELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFFOUM7OztHQUdHO0FBQ0gsTUFBTSxVQUFVLGdCQUFnQixDQUFDLElBQXNCLEVBQUUsR0FBVztJQUNoRSxJQUFJLEdBQUcsR0FBRyxFQUFFLENBQUM7SUFDYixJQUFJLFFBQWdCLENBQUE7SUFDcEIsT0FBTyxRQUFRLEdBQUcsU0FBUyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFDdkMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUNELE9BQU8sR0FBRyxDQUFDO0FBQ2YsQ0FBQztBQUVELHNFQUFzRTtBQUN0RSxJQUFJLFdBQVcsR0FBRyxJQUFJLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUMzQyxJQUFJLFlBQVksR0FBRyxJQUFJLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUMvQyxJQUFJLFdBQVcsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0FBRXBDOzs7Ozs7R0FNRztBQUNILE1BQU0sVUFBVSxhQUFhLENBQUMsSUFBc0IsRUFBRSxHQUFXO0lBQzdELE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQztJQUNsQixJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUM7SUFFaEIsT0FBTyxTQUFTLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQztRQUFDLENBQUM7SUFFcEMsT0FB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dWludDE2LmpzXCI7XHJcbmltcG9ydCB7IHJlYWRVaW50MzIgfSBmcm9tIFwiLi4vdXRpbC9yZWFkLXVpbnQzMi5qc1wiO1xyXG5pbXBvcnQgeyByZWFkVWludDggfSBmcm9tIFwiLi4vdXRpbC9yZWFkLXVpbnQ4LmpzXCI7XHJcbmltcG9ydCB7IEluc3RhbnRpYXRlZFdhc20gfSBmcm9tIFwiLi4vd2FzbS5qc1wiO1xyXG5cclxuLyoqXHJcbiAqIFRPRE86IENhbid0IEMrKyBpZGVudGlmaWVycyBpbmNsdWRlIG5vbi1BU0NJSSBjaGFyYWN0ZXJzPyBcclxuICogV2h5IGRvIGFsbCB0aGUgdHlwZSBkZWNvZGluZyBmdW5jdGlvbnMgdXNlIHRoaXM/XHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gcmVhZExhdGluMVN0cmluZyhpbXBsOiBJbnN0YW50aWF0ZWRXYXNtLCBwdHI6IG51bWJlcik6IHN0cmluZyB7XHJcbiAgICBsZXQgcmV0ID0gXCJcIjtcclxuICAgIGxldCBuZXh0Qnl0ZTogbnVtYmVyXHJcbiAgICB3aGlsZSAobmV4dEJ5dGUgPSByZWFkVWludDgoaW1wbCwgcHRyKyspKSB7XHJcbiAgICAgICAgcmV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUobmV4dEJ5dGUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJldDtcclxufVxyXG5cclxuLy8gTm90ZTogSW4gV29ya2xldHMsIGBUZXh0RGVjb2RlcmAgYW5kIGBUZXh0RW5jb2RlcmAgbmVlZCBhIHBvbHlmaWxsLlxyXG5sZXQgdXRmOERlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoXCJ1dGYtOFwiKTtcclxubGV0IHV0ZjE2RGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcihcInV0Zi0xNmxlXCIpO1xyXG5sZXQgdXRmOEVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTtcclxuXHJcbi8qKlxyXG4gKiBEZWNvZGVzIGEgbnVsbC10ZXJtaW5hdGVkIFVURi04IHN0cmluZy4gSWYgeW91IGtub3cgdGhlIGxlbmd0aCBvZiB0aGUgc3RyaW5nLCB5b3UgY2FuIHNhdmUgdGltZSBieSB1c2luZyBgdXRmOFRvU3RyaW5nTGAgaW5zdGVhZC5cclxuICogXHJcbiAqIEBwYXJhbSBpbXBsIFxyXG4gKiBAcGFyYW0gcHRyIFxyXG4gKiBAcmV0dXJucyBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiB1dGY4VG9TdHJpbmdaKGltcGw6IEluc3RhbnRpYXRlZFdhc20sIHB0cjogbnVtYmVyKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHN0YXJ0ID0gcHRyO1xyXG4gICAgbGV0IGVuZCA9IHN0YXJ0O1xyXG5cclxuICAgIHdoaWxlIChyZWFkVWludDgoaW1wbCwgZW5kKyspICE9IDApO1xyXG5cclxuICAgIHJldHVybiB1dGY4VG9TdHJpbmdMKGltcGwsIHN0YXJ0LCBlbmQgLSBzdGFydCAtIDEpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdXRmMTZUb1N0cmluZ1ooaW1wbDogSW5zdGFudGlhdGVkV2FzbSwgcHRyOiBudW1iZXIpOiBzdHJpbmcge1xyXG4gICAgY29uc3Qgc3RhcnQgPSBwdHI7XHJcbiAgICBsZXQgZW5kID0gc3RhcnQ7XHJcblxyXG4gICAgd2hpbGUgKHJlYWRVaW50MTYoaW1wbCwgZW5kKSAhPSAwKSB7IGVuZCArPSAyOyB9XHJcblxyXG4gICAgcmV0dXJuIHV0ZjE2VG9TdHJpbmdMKGltcGwsIHN0YXJ0LCBlbmQgLSBzdGFydCAtIDEpO1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiB1dGYzMlRvU3RyaW5nWihpbXBsOiBJbnN0YW50aWF0ZWRXYXNtLCBwdHI6IG51bWJlcik6IHN0cmluZyB7XHJcbiAgICBjb25zdCBzdGFydCA9IHB0cjtcclxuICAgIGxldCBlbmQgPSBzdGFydDtcclxuXHJcbiAgICB3aGlsZSAocmVhZFVpbnQzMihpbXBsLCBlbmQpICE9IDApIHsgZW5kICs9IDQ7IH1cclxuXHJcbiAgICByZXR1cm4gdXRmMzJUb1N0cmluZ0woaW1wbCwgc3RhcnQsIGVuZCAtIHN0YXJ0IC0gMSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB1dGY4VG9TdHJpbmdMKGltcGw6IEluc3RhbnRpYXRlZFdhc20sIHB0cjogbnVtYmVyLCBieXRlQ291bnQ6IG51bWJlcik6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdXRmOERlY29kZXIuZGVjb2RlKG5ldyBVaW50OEFycmF5KGltcGwuZXhwb3J0cy5tZW1vcnkuYnVmZmVyLCBwdHIsIGJ5dGVDb3VudCkpO1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiB1dGYxNlRvU3RyaW5nTChpbXBsOiBJbnN0YW50aWF0ZWRXYXNtLCBwdHI6IG51bWJlciwgd2NoYXJDb3VudDogbnVtYmVyKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB1dGYxNkRlY29kZXIuZGVjb2RlKG5ldyBVaW50OEFycmF5KGltcGwuZXhwb3J0cy5tZW1vcnkuYnVmZmVyLCBwdHIsIHdjaGFyQ291bnQgKiAyKSk7XHJcbn1cclxuZXhwb3J0IGZ1bmN0aW9uIHV0ZjMyVG9TdHJpbmdMKGltcGw6IEluc3RhbnRpYXRlZFdhc20sIHB0cjogbnVtYmVyLCB3Y2hhckNvdW50OiBudW1iZXIpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgY2hhcnMgPSAobmV3IFVpbnQzMkFycmF5KGltcGwuZXhwb3J0cy5tZW1vcnkuYnVmZmVyLCBwdHIsIHdjaGFyQ291bnQpKTtcclxuICAgIGxldCByZXQgPSBcIlwiO1xyXG4gICAgZm9yIChsZXQgY2ggb2YgY2hhcnMpIHtcclxuICAgICAgICByZXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjaCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmV0O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gc3RyaW5nVG9VdGY4KHN0cmluZzogc3RyaW5nKTogQXJyYXlCdWZmZXIge1xyXG4gICAgcmV0dXJuIHV0ZjhFbmNvZGVyLmVuY29kZShzdHJpbmcpLmJ1ZmZlcjtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHN0cmluZ1RvVXRmMTYoc3RyaW5nOiBzdHJpbmcpOiBBcnJheUJ1ZmZlciB7XHJcbiAgICBsZXQgcmV0ID0gbmV3IFVpbnQxNkFycmF5KG5ldyBBcnJheUJ1ZmZlcihzdHJpbmcubGVuZ3RoKSk7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJldC5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgIHJldFtpXSA9IHN0cmluZy5jaGFyQ29kZUF0KGkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJldC5idWZmZXI7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzdHJpbmdUb1V0ZjMyKHN0cmluZzogc3RyaW5nKTogQXJyYXlCdWZmZXIge1xyXG4gICAgbGV0IHRydWVMZW5ndGggPSAwO1xyXG4gICAgLy8gVGhlIHdvcnN0LWNhc2Ugc2NlbmFyaW8gaXMgYSBzdHJpbmcgb2YgYWxsIHN1cnJvZ2F0ZS1wYWlycywgc28gYWxsb2NhdGUgdGhhdC5cclxuICAgIC8vIFdlJ2xsIHNocmluayBpdCB0byB0aGUgYWN0dWFsIHNpemUgYWZ0ZXJ3YXJkcy5cclxuICAgIGxldCB0ZW1wID0gbmV3IFVpbnQzMkFycmF5KG5ldyBBcnJheUJ1ZmZlcihzdHJpbmcubGVuZ3RoICogNCAqIDIpKTtcclxuICAgIGZvciAoY29uc3QgY2ggb2Ygc3RyaW5nKSB7XHJcbiAgICAgICAgdGVtcFt0cnVlTGVuZ3RoXSA9IGNoLmNvZGVQb2ludEF0KDApITtcclxuICAgICAgICArK3RydWVMZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRlbXAuYnVmZmVyLnNsaWNlKDAsIHRydWVMZW5ndGggKiA0KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFVzZWQgd2hlbiBzZW5kaW5nIHN0cmluZ3MgZnJvbSBKUyB0byBXQVNNLlxyXG4gKiBcclxuICogXHJcbiAqIEBwYXJhbSBzdHIgXHJcbiAqIEByZXR1cm5zIFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGxlbmd0aEJ5dGVzVVRGOChzdHI6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICBsZXQgbGVuID0gMDtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgbGV0IGMgPSBzdHIuY29kZVBvaW50QXQoaSkhO1xyXG4gICAgICAgIGlmIChjIDw9IDB4N0YpXHJcbiAgICAgICAgICAgIGxlbisrO1xyXG4gICAgICAgIGVsc2UgaWYgKGMgPD0gMHg3RkYpXHJcbiAgICAgICAgICAgIGxlbiArPSAyO1xyXG4gICAgICAgIGVsc2UgaWYgKGMgPD0gMHg3RkZGKVxyXG4gICAgICAgICAgICBsZW4gKz0gMztcclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbGVuICs9IDQ7XHJcbiAgICAgICAgICAgICsraTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbGVuO1xyXG59Il19