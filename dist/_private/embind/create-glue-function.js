import { InstantiatedWasm } from "../../wasm.js";
import { renameFunction } from "./create-named-function.js";
import { runDestructors } from "./destructors.js";
import { EmboundClass } from "./embound-class.js";
import { getTableFunction } from "./get-table-function.js";
import { getTypeInfo } from "./get-type-info.js";
/**
 * Creates a JS function that calls a C++ function, accounting for `this` types and context.
 *
 * It converts all arguments before passing them, and converts the return type before returning.
 *
 * @param impl
 * @param argTypeIds All RTTI TypeIds, in the order of [RetType, ThisType, ...ArgTypes]. ThisType can be null for standalone functions.
 * @param invokerSignature A pointer to the signature string.
 * @param invokerIndex The index to the invoker function in the `WebAssembly.Table`.
 * @param invokerContext The context pointer to use, if any.
 * @returns
 */
/* eslint @typescript-eslint/no-unsafe-function-type: "off" */
export async function createGlueFunction(impl, name, returnTypeId, argTypeIds, invokerSignature, invokerIndex, invokerContext) {
    const [returnType, ...argTypes] = await getTypeInfo(returnTypeId, ...argTypeIds);
    const rawInvoker = getTableFunction(impl, invokerSignature, invokerIndex);
    return renameFunction(name, function (...jsArgs) {
        const wiredThis = this ? this._this : undefined;
        const wiredArgs = [];
        const stackBasedDestructors = []; // Used to pretend like we're a part of the WASM stack, which would destroy these objects afterwards.
        if (invokerContext)
            wiredArgs.push(invokerContext);
        if (wiredThis)
            wiredArgs.push(wiredThis);
        // Convert each JS argument to its WASM equivalent (generally a pointer, or int/float)
        // TODO: Test performance regarding looping through each argument before passing it to a function.
        // I'm hoping that the JIT compiler understands that argTypes.length never changes and unrolls it...
        for (let i = 0; i < argTypes.length; ++i) {
            const type = argTypes[i];
            const arg = jsArgs[i];
            const { jsValue, wireValue, stackDestructor } = type.toWireType(arg);
            wiredArgs.push(wireValue);
            if (stackDestructor)
                stackBasedDestructors.push(() => stackDestructor(jsValue, wireValue));
        }
        // Finally, call the "raw" WASM function
        const wiredReturn = rawInvoker(...wiredArgs);
        // Still pretending we're a part of the stack, 
        // now destruct everything we "pushed" onto it.
        runDestructors(stackBasedDestructors);
        // Convert whatever the WASM function returned to a JS representation
        // If the object returned is Disposable, then we let the user dispose of it
        // when ready.
        //
        // Otherwise (namely strings), dispose its original representation now.
        if (returnType == null)
            return undefined;
        const { jsValue, wireValue, stackDestructor } = returnType.fromWireType(wiredReturn);
        if (stackDestructor && !(jsValue && typeof jsValue == "object" && (Symbol.dispose in jsValue)))
            stackDestructor(jsValue, wireValue);
        return jsValue;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWdsdWUtZnVuY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvX3ByaXZhdGUvZW1iaW5kL2NyZWF0ZS1nbHVlLWZ1bmN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFHakQ7Ozs7Ozs7Ozs7O0dBV0c7QUFDSCw4REFBOEQ7QUFDOUQsTUFBTSxDQUFDLEtBQUssVUFBVSxrQkFBa0IsQ0FDcEMsSUFBc0IsRUFDdEIsSUFBWSxFQUNaLFlBQW9CLEVBQ3BCLFVBQW9CLEVBQ3BCLGdCQUF3QixFQUN4QixZQUFvQixFQUNwQixjQUE2QjtJQU03QixNQUFNLENBQUMsVUFBVSxFQUFFLEdBQUcsUUFBUSxDQUFDLEdBQUcsTUFBTSxXQUFXLENBQW1CLFlBQVksRUFBRSxHQUFHLFVBQVUsQ0FBQyxDQUFDO0lBQ25HLE1BQU0sVUFBVSxHQUFHLGdCQUFnQixDQUFzQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFFL0csT0FBTyxjQUFjLENBQUMsSUFBSSxFQUFFLFVBQThCLEdBQUcsTUFBaUI7UUFDMUUsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDaEQsTUFBTSxTQUFTLEdBQWdCLEVBQUUsQ0FBQztRQUNsQyxNQUFNLHFCQUFxQixHQUFtQixFQUFFLENBQUMsQ0FBRyxxR0FBcUc7UUFFekosSUFBSSxjQUFjO1lBQ2QsU0FBUyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNuQyxJQUFJLFNBQVM7WUFDVCxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTlCLHNGQUFzRjtRQUN0RixrR0FBa0c7UUFDbEcsb0dBQW9HO1FBQ3BHLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFDdkMsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0QixNQUFNLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3JFLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDMUIsSUFBSSxlQUFlO2dCQUNmLHFCQUFxQixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDOUUsQ0FBQztRQUVELHdDQUF3QztRQUN4QyxNQUFNLFdBQVcsR0FBYyxVQUFVLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQztRQUV4RCwrQ0FBK0M7UUFDL0MsK0NBQStDO1FBQy9DLGNBQWMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBRXRDLHFFQUFxRTtRQUNyRSwyRUFBMkU7UUFDM0UsY0FBYztRQUNkLEVBQUU7UUFDRix1RUFBdUU7UUFDdkUsSUFBSSxVQUFVLElBQUksSUFBSTtZQUNsQixPQUFPLFNBQVMsQ0FBQztRQUVyQixNQUFNLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQUUsR0FBRyxVQUFVLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JGLElBQUksZUFBZSxJQUFJLENBQUMsQ0FBQyxPQUFPLElBQUksT0FBTyxPQUFPLElBQUksUUFBUSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQztZQUMxRixlQUFlLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRXhDLE9BQU8sT0FBTyxDQUFDO0lBRW5CLENBQU0sQ0FBQyxDQUFDO0FBQ1osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluc3RhbnRpYXRlZFdhc20gfSBmcm9tIFwiLi4vLi4vd2FzbS5qc1wiO1xyXG5pbXBvcnQgeyByZW5hbWVGdW5jdGlvbiB9IGZyb20gXCIuL2NyZWF0ZS1uYW1lZC1mdW5jdGlvbi5qc1wiO1xyXG5pbXBvcnQgeyBydW5EZXN0cnVjdG9ycyB9IGZyb20gXCIuL2Rlc3RydWN0b3JzLmpzXCI7XHJcbmltcG9ydCB7IEVtYm91bmRDbGFzcyB9IGZyb20gXCIuL2VtYm91bmQtY2xhc3MuanNcIjtcclxuaW1wb3J0IHsgZ2V0VGFibGVGdW5jdGlvbiB9IGZyb20gXCIuL2dldC10YWJsZS1mdW5jdGlvbi5qc1wiO1xyXG5pbXBvcnQgeyBnZXRUeXBlSW5mbyB9IGZyb20gXCIuL2dldC10eXBlLWluZm8uanNcIjtcclxuaW1wb3J0IHR5cGUgeyBFbWJvdW5kUmVnaXN0ZXJlZFR5cGUsIFdpcmVUeXBlcyB9IGZyb20gXCIuL3R5cGVzLmpzXCI7XHJcblxyXG4vKipcclxuICogQ3JlYXRlcyBhIEpTIGZ1bmN0aW9uIHRoYXQgY2FsbHMgYSBDKysgZnVuY3Rpb24sIGFjY291bnRpbmcgZm9yIGB0aGlzYCB0eXBlcyBhbmQgY29udGV4dC5cclxuICogXHJcbiAqIEl0IGNvbnZlcnRzIGFsbCBhcmd1bWVudHMgYmVmb3JlIHBhc3NpbmcgdGhlbSwgYW5kIGNvbnZlcnRzIHRoZSByZXR1cm4gdHlwZSBiZWZvcmUgcmV0dXJuaW5nLlxyXG4gKiBcclxuICogQHBhcmFtIGltcGwgXHJcbiAqIEBwYXJhbSBhcmdUeXBlSWRzIEFsbCBSVFRJIFR5cGVJZHMsIGluIHRoZSBvcmRlciBvZiBbUmV0VHlwZSwgVGhpc1R5cGUsIC4uLkFyZ1R5cGVzXS4gVGhpc1R5cGUgY2FuIGJlIG51bGwgZm9yIHN0YW5kYWxvbmUgZnVuY3Rpb25zLlxyXG4gKiBAcGFyYW0gaW52b2tlclNpZ25hdHVyZSBBIHBvaW50ZXIgdG8gdGhlIHNpZ25hdHVyZSBzdHJpbmcuXHJcbiAqIEBwYXJhbSBpbnZva2VySW5kZXggVGhlIGluZGV4IHRvIHRoZSBpbnZva2VyIGZ1bmN0aW9uIGluIHRoZSBgV2ViQXNzZW1ibHkuVGFibGVgLlxyXG4gKiBAcGFyYW0gaW52b2tlckNvbnRleHQgVGhlIGNvbnRleHQgcG9pbnRlciB0byB1c2UsIGlmIGFueS5cclxuICogQHJldHVybnMgXHJcbiAqL1xyXG4vKiBlc2xpbnQgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVuc2FmZS1mdW5jdGlvbi10eXBlOiBcIm9mZlwiICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVHbHVlRnVuY3Rpb248RiBleHRlbmRzICgoLi4uYXJnczogdW5rbm93bltdKSA9PiB1bmtub3duKSB8IEZ1bmN0aW9uPihcclxuICAgIGltcGw6IEluc3RhbnRpYXRlZFdhc20sXHJcbiAgICBuYW1lOiBzdHJpbmcsXHJcbiAgICByZXR1cm5UeXBlSWQ6IG51bWJlcixcclxuICAgIGFyZ1R5cGVJZHM6IG51bWJlcltdLFxyXG4gICAgaW52b2tlclNpZ25hdHVyZTogbnVtYmVyLFxyXG4gICAgaW52b2tlckluZGV4OiBudW1iZXIsXHJcbiAgICBpbnZva2VyQ29udGV4dDogbnVtYmVyIHwgbnVsbFxyXG4pOiBQcm9taXNlPEY+IHtcclxuICAgIHR5cGUgVCA9IFBhcmFtZXRlcnM8RiAmICgoLi4uYXJnczogdW5rbm93bltdKSA9PiB1bmtub3duKT47XHJcbiAgICB0eXBlIFIgPSBFbWJvdW5kUmVnaXN0ZXJlZFR5cGU8V2lyZVR5cGVzLCBUW251bWJlcl0+O1xyXG4gICAgdHlwZSBBcmdUeXBlcyA9IEVtYm91bmRSZWdpc3RlcmVkVHlwZTxXaXJlVHlwZXMsIFRbbnVtYmVyXT5bXTtcclxuXHJcbiAgICBjb25zdCBbcmV0dXJuVHlwZSwgLi4uYXJnVHlwZXNdID0gYXdhaXQgZ2V0VHlwZUluZm88W1IsIC4uLkFyZ1R5cGVzXT4ocmV0dXJuVHlwZUlkLCAuLi5hcmdUeXBlSWRzKTtcclxuICAgIGNvbnN0IHJhd0ludm9rZXIgPSBnZXRUYWJsZUZ1bmN0aW9uPCguLi5hcmdzOiBXaXJlVHlwZXNbXSkgPT4gV2lyZVR5cGVzPihpbXBsLCBpbnZva2VyU2lnbmF0dXJlLCBpbnZva2VySW5kZXgpO1xyXG5cclxuICAgIHJldHVybiByZW5hbWVGdW5jdGlvbihuYW1lLCBmdW5jdGlvbiAodGhpczogRW1ib3VuZENsYXNzLCAuLi5qc0FyZ3M6IHVua25vd25bXSkge1xyXG4gICAgICAgIGNvbnN0IHdpcmVkVGhpcyA9IHRoaXMgPyB0aGlzLl90aGlzIDogdW5kZWZpbmVkO1xyXG4gICAgICAgIGNvbnN0IHdpcmVkQXJnczogV2lyZVR5cGVzW10gPSBbXTtcclxuICAgICAgICBjb25zdCBzdGFja0Jhc2VkRGVzdHJ1Y3RvcnM6ICgoKSA9PiB2b2lkKVtdID0gW107ICAgLy8gVXNlZCB0byBwcmV0ZW5kIGxpa2Ugd2UncmUgYSBwYXJ0IG9mIHRoZSBXQVNNIHN0YWNrLCB3aGljaCB3b3VsZCBkZXN0cm95IHRoZXNlIG9iamVjdHMgYWZ0ZXJ3YXJkcy5cclxuXHJcbiAgICAgICAgaWYgKGludm9rZXJDb250ZXh0KVxyXG4gICAgICAgICAgICB3aXJlZEFyZ3MucHVzaChpbnZva2VyQ29udGV4dCk7XHJcbiAgICAgICAgaWYgKHdpcmVkVGhpcylcclxuICAgICAgICAgICAgd2lyZWRBcmdzLnB1c2god2lyZWRUaGlzKTtcclxuXHJcbiAgICAgICAgLy8gQ29udmVydCBlYWNoIEpTIGFyZ3VtZW50IHRvIGl0cyBXQVNNIGVxdWl2YWxlbnQgKGdlbmVyYWxseSBhIHBvaW50ZXIsIG9yIGludC9mbG9hdClcclxuICAgICAgICAvLyBUT0RPOiBUZXN0IHBlcmZvcm1hbmNlIHJlZ2FyZGluZyBsb29waW5nIHRocm91Z2ggZWFjaCBhcmd1bWVudCBiZWZvcmUgcGFzc2luZyBpdCB0byBhIGZ1bmN0aW9uLlxyXG4gICAgICAgIC8vIEknbSBob3BpbmcgdGhhdCB0aGUgSklUIGNvbXBpbGVyIHVuZGVyc3RhbmRzIHRoYXQgYXJnVHlwZXMubGVuZ3RoIG5ldmVyIGNoYW5nZXMgYW5kIHVucm9sbHMgaXQuLi5cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ1R5cGVzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBhcmdUeXBlc1tpXTtcclxuICAgICAgICAgICAgY29uc3QgYXJnID0ganNBcmdzW2ldO1xyXG4gICAgICAgICAgICBjb25zdCB7IGpzVmFsdWUsIHdpcmVWYWx1ZSwgc3RhY2tEZXN0cnVjdG9yIH0gPSB0eXBlLnRvV2lyZVR5cGUoYXJnKTtcclxuICAgICAgICAgICAgd2lyZWRBcmdzLnB1c2god2lyZVZhbHVlKTtcclxuICAgICAgICAgICAgaWYgKHN0YWNrRGVzdHJ1Y3RvcilcclxuICAgICAgICAgICAgICAgIHN0YWNrQmFzZWREZXN0cnVjdG9ycy5wdXNoKCgpID0+IHN0YWNrRGVzdHJ1Y3Rvcihqc1ZhbHVlLCB3aXJlVmFsdWUpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEZpbmFsbHksIGNhbGwgdGhlIFwicmF3XCIgV0FTTSBmdW5jdGlvblxyXG4gICAgICAgIGNvbnN0IHdpcmVkUmV0dXJuOiBXaXJlVHlwZXMgPSByYXdJbnZva2VyKC4uLndpcmVkQXJncyk7XHJcblxyXG4gICAgICAgIC8vIFN0aWxsIHByZXRlbmRpbmcgd2UncmUgYSBwYXJ0IG9mIHRoZSBzdGFjaywgXHJcbiAgICAgICAgLy8gbm93IGRlc3RydWN0IGV2ZXJ5dGhpbmcgd2UgXCJwdXNoZWRcIiBvbnRvIGl0LlxyXG4gICAgICAgIHJ1bkRlc3RydWN0b3JzKHN0YWNrQmFzZWREZXN0cnVjdG9ycyk7XHJcblxyXG4gICAgICAgIC8vIENvbnZlcnQgd2hhdGV2ZXIgdGhlIFdBU00gZnVuY3Rpb24gcmV0dXJuZWQgdG8gYSBKUyByZXByZXNlbnRhdGlvblxyXG4gICAgICAgIC8vIElmIHRoZSBvYmplY3QgcmV0dXJuZWQgaXMgRGlzcG9zYWJsZSwgdGhlbiB3ZSBsZXQgdGhlIHVzZXIgZGlzcG9zZSBvZiBpdFxyXG4gICAgICAgIC8vIHdoZW4gcmVhZHkuXHJcbiAgICAgICAgLy9cclxuICAgICAgICAvLyBPdGhlcndpc2UgKG5hbWVseSBzdHJpbmdzKSwgZGlzcG9zZSBpdHMgb3JpZ2luYWwgcmVwcmVzZW50YXRpb24gbm93LlxyXG4gICAgICAgIGlmIChyZXR1cm5UeXBlID09IG51bGwpXHJcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcblxyXG4gICAgICAgIGNvbnN0IHsganNWYWx1ZSwgd2lyZVZhbHVlLCBzdGFja0Rlc3RydWN0b3IgfSA9IHJldHVyblR5cGUuZnJvbVdpcmVUeXBlKHdpcmVkUmV0dXJuKTtcclxuICAgICAgICBpZiAoc3RhY2tEZXN0cnVjdG9yICYmICEoanNWYWx1ZSAmJiB0eXBlb2YganNWYWx1ZSA9PSBcIm9iamVjdFwiICYmIChTeW1ib2wuZGlzcG9zZSBpbiBqc1ZhbHVlKSkpXHJcbiAgICAgICAgICAgIHN0YWNrRGVzdHJ1Y3Rvcihqc1ZhbHVlLCB3aXJlVmFsdWUpO1xyXG5cclxuICAgICAgICByZXR1cm4ganNWYWx1ZTtcclxuXHJcbiAgICB9IGFzIEYpO1xyXG59XHJcbiJdfQ==