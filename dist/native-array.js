import {} from "./types.js";
import { InstantiatedWasm } from "./wasm.js";
export class InvalidArrayLengthError extends Error {
    constructor(sourceByteCount, targetItemSize) {
        super(`The array could not be assigned because the source array is ${sourceByteCount} byte${sourceByteCount == 1 ? "" : "s"} long, which is not divisible by ${targetItemSize}, the number of bytes per element in the target array.`);
    }
}
/**
 * Represents a `TypedArray` (e.g. `Int8Array`, etc.) that exists in WASM memory instead of JS memory.
 *
 * As this class is Disposable, it should be created with `using` so your program doesn't OOM.
 */
class NativeTypedArray {
    TypedArray;
    _instance;
    _bytesPerWord;
    // This is assigned in a function that's definitely called from the constructor
    _impl;
    _currentCount;
    _ptr = null;
    _malloc;
    _realloc;
    _free;
    _updateTypedArrayImpl(newAddress, newCount) {
        this._impl = new this.TypedArray(this._instance.exports.memory.buffer, newAddress, newCount);
    }
    /**
     * Like `TypedArray.set`, this does not resize the array based on the input. If you're assigning to this array from a source, be sure to call `resize` first.
     * @param other The source array to copy from
     * @param offset Where to start writing to in this array
     */
    set(other, offset = 0) {
        this._impl.set(other, offset);
    }
    /**
     * This is simply `resize`, then `set`, with accommodation made for `TypedArray`s of different sizes
     *
     * @param other The source array that this array will copy into WASM memory. It can be any kind of `TypedArray`.
     */
    assign(other) {
        const ourNewCount = other.byteLength / this._impl.BYTES_PER_ELEMENT;
        if (Math.floor(ourNewCount) != ourNewCount) {
            throw new InvalidArrayLengthError(other.byteLength, this._impl.BYTES_PER_ELEMENT);
        }
        this.resize(ourNewCount);
        this.set(new this.TypedArray(other));
    }
    /**
     * Identically to `TypedArray.at`, a negative `index` will count backwards from the end of the array.
     */
    at(index) { return this._impl.at(index); }
    /**
     * Resizes this array in WASM memory, allocating as necessary.
     *
     * It's recommended to just use `assign`, which copies an entire source array in one step, because
     * as usual, reading the newly assigned memory before writing to it is undefined behavior and **will** immediately send you to crime jail.
     *
     * @param newCount The number of items in this array (not the total size in bytes)
     */
    resize(newCount) {
        if (newCount != this._currentCount) {
            const newByteCount = newCount * this._bytesPerWord;
            if (this._ptr)
                this._ptr = this._realloc(this._ptr, newByteCount);
            else
                this._ptr = this._malloc(newByteCount);
            this._updateTypedArrayImpl(this._ptr, newCount);
        }
    }
    /**
     * Returns the address of this array (for use with other WASM functions that expect a pointer that points to an array)
     */
    get address() { return this._ptr; }
    constructor(TypedArray, _instance, _bytesPerWord, initialCount) {
        this.TypedArray = TypedArray;
        this._instance = _instance;
        this._bytesPerWord = _bytesPerWord;
        // eslint-disable-next-line @typescript-eslint/unbound-method
        const { malloc, realloc, free } = _instance.exports;
        this._malloc = malloc;
        this._realloc = realloc;
        this._free = free;
        this._currentCount = initialCount || 0;
        if (initialCount) {
            this._ptr = this._malloc(initialCount * this._bytesPerWord);
            this._updateTypedArrayImpl(this._ptr, initialCount);
        }
        else
            this._ptr = null;
        this._updateTypedArrayImpl(this._ptr || 0, initialCount || 0);
    }
    [Symbol.dispose]() {
        if (this._ptr)
            this._free(this._ptr);
    }
}
export class NativeInt8Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(Int8Array, instance, 1, initialCount); }
}
export class NativeUint8Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(Uint8Array, instance, 1, initialCount); }
}
export class NativeUint8ClampedArray extends NativeTypedArray {
    constructor(instance, initialCount) { super(Uint8ClampedArray, instance, 1, initialCount); }
}
export class NativeInt16Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(Int16Array, instance, 2, initialCount); }
}
export class NativeUint16Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(Uint16Array, instance, 2, initialCount); }
}
export class NativeInt32Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(Int32Array, instance, 4, initialCount); }
}
export class NativeUint32Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(Uint32Array, instance, 4, initialCount); }
}
export class NativeBigInt64Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(BigInt64Array, instance, 8, initialCount); }
}
export class NativeBigUint64Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(BigUint64Array, instance, 8, initialCount); }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlLWFycmF5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL25hdGl2ZS1hcnJheS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWdCLE1BQU0sWUFBWSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUk3QyxNQUFNLE9BQU8sdUJBQXdCLFNBQVEsS0FBSztJQUM5QyxZQUFZLGVBQXVCLEVBQUUsY0FBc0I7UUFDdkQsS0FBSyxDQUFDLCtEQUErRCxlQUFlLFFBQVEsZUFBZSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLG9DQUFvQyxjQUFjLHdEQUF3RCxDQUFDLENBQUE7SUFDMU8sQ0FBQztDQUNKO0FBRUQ7Ozs7R0FJRztBQUNILE1BQWUsZ0JBQWdCO0lBcUVHO0lBQStGO0lBQXVDO0lBbkVwSywrRUFBK0U7SUFDckUsS0FBSyxDQUFLO0lBRVosYUFBYSxDQUFTO0lBQ3RCLElBQUksR0FBNEIsSUFBSSxDQUFDO0lBQ3JDLE9BQU8sQ0FBb0M7SUFDM0MsUUFBUSxDQUFpRDtJQUN6RCxLQUFLLENBQWlDO0lBR3RDLHFCQUFxQixDQUFDLFVBQWtCLEVBQUUsUUFBZ0I7UUFDOUQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDakcsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxHQUFHLENBQUMsS0FBUSxFQUFFLE1BQU0sR0FBRyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQWMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILE1BQU0sQ0FBQyxLQUFxQjtRQUN4QixNQUFNLFdBQVcs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QUUsWUFBdUMsSUFBSSxLQUFLLENBQUMsYUFBYSxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO0NBQUU7QUFDbE4sTUFBTSxPQUFPLG9CQUFxQixTQUFRLGdCQUFnQztJQUFHLFlBQVksUUFBMEIsRUFBRSxZQUF1QyxJQUFJLEtBQUssQ0FBQyxjQUFjLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7Q0FBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHR5cGUgUG9pbnRlciB9IGZyb20gXCIuL3R5cGVzLmpzXCI7XHJcbmltcG9ydCB7IEluc3RhbnRpYXRlZFdhc20gfSBmcm9tIFwiLi93YXNtLmpzXCI7XHJcblxyXG50eXBlIEFsbFR5cGVkQXJyYXlzID0gVWludDhBcnJheSB8IEludDhBcnJheSB8IFVpbnQ4Q2xhbXBlZEFycmF5IHwgVWludDE2QXJyYXkgfCBJbnQxNkFycmF5IHwgVWludDMyQXJyYXkgfCBJbnQzMkFycmF5IHwgQmlnSW50NjRBcnJheSB8IEJpZ1VpbnQ2NEFycmF5O1xyXG5cclxuZXhwb3J0IGNsYXNzIEludmFsaWRBcnJheUxlbmd0aEVycm9yIGV4dGVuZHMgRXJyb3Ige1xyXG4gICAgY29uc3RydWN0b3Ioc291cmNlQnl0ZUNvdW50OiBudW1iZXIsIHRhcmdldEl0ZW1TaXplOiBudW1iZXIpIHtcclxuICAgICAgICBzdXBlcihgVGhlIGFycmF5IGNvdWxkIG5vdCBiZSBhc3NpZ25lZCBiZWNhdXNlIHRoZSBzb3VyY2UgYXJyYXkgaXMgJHtzb3VyY2VCeXRlQ291bnR9IGJ5dGUke3NvdXJjZUJ5dGVDb3VudCA9PSAxID8gXCJcIiA6IFwic1wifSBsb25nLCB3aGljaCBpcyBub3QgZGl2aXNpYmxlIGJ5ICR7dGFyZ2V0SXRlbVNpemV9LCB0aGUgbnVtYmVyIG9mIGJ5dGVzIHBlciBlbGVtZW50IGluIHRoZSB0YXJnZXQgYXJyYXkuYClcclxuICAgIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIFJlcHJlc2VudHMgYSBgVHlwZWRBcnJheWAgKGUuZy4gYEludDhBcnJheWAsIGV0Yy4pIHRoYXQgZXhpc3RzIGluIFdBU00gbWVtb3J5IGluc3RlYWQgb2YgSlMgbWVtb3J5LlxyXG4gKiBcclxuICogQXMgdGhpcyBjbGFzcyBpcyBEaXNwb3NhYmxlLCBpdCBzaG91bGQgYmUgY3JlYXRlZCB3aXRoIGB1c2luZ2Agc28geW91ciBwcm9ncmFtIGRvZXNuJ3QgT09NLlxyXG4gKi9cclxuYWJzdHJhY3QgY2xhc3MgTmF0aXZlVHlwZWRBcnJheTxUIGV4dGVuZHMgQWxsVHlwZWRBcnJheXM+IHtcclxuXHJcbiAgICAvLyBUaGlzIGlzIGFzc2lnbmVkIGluIGEgZnVuY3Rpb24gdGhhdCdzIGRlZmluaXRlbHkgY2FsbGVkIGZyb20gdGhlIGNvbnN0cnVjdG9yXHJcbiAgICBwcm90ZWN0ZWQgX2ltcGwhOiBUO1xyXG5cclxuICAgIHByaXZhdGUgX2N1cnJlbnRDb3VudDogbnVtYmVyO1xyXG4gICAgcHJpdmF0ZSBfcHRyOiBQb2ludGVyPHVua25vd24+IHwgbnVsbCA9IG51bGw7XHJcbiAgICBwcml2YXRlIF9tYWxsb2M6ICgoc2l6ZTogbnVtYmVyKSA9PiBudW1iZXIpIHwgbnVsbDtcclxuICAgIHByaXZhdGUgX3JlYWxsb2M6ICgocHRyOiBudW1iZXIsIHNpemU6IG51bWJlcikgPT4gbnVtYmVyKSB8IG51bGw7XHJcbiAgICBwcml2YXRlIF9mcmVlOiAoKHB0cjogbnVtYmVyKSA9PiB2b2lkKSB8IG51bGw7XHJcblxyXG5cclxuICAgIHByaXZhdGUgX3VwZGF0ZVR5cGVkQXJyYXlJbXBsKG5ld0FkZHJlc3M6IG51bWJlciwgbmV3Q291bnQ6IG51bWJlcikge1xyXG4gICAgICAgIHRoaXMuX2ltcGwgPSBuZXcgdGhpcy5UeXBlZEFycmF5KHRoaXMuX2luc3RhbmNlLmV4cG9ydHMubWVtb3J5LmJ1ZmZlciwgbmV3QWRkcmVzcywgbmV3Q291bnQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogTGlrZSBgVHlwZWRBcnJheS5zZXRgLCB0aGlzIGRvZXMgbm90IHJlc2l6ZSB0aGUgYXJyYXkgYmFzZWQgb24gdGhlIGlucHV0LiBJZiB5b3UncmUgYXNzaWduaW5nIHRvIHRoaXMgYXJyYXkgZnJvbSBhIHNvdXJjZSwgYmUgc3VyZSB0byBjYWxsIGByZXNpemVgIGZpcnN0LlxyXG4gICAgICogQHBhcmFtIG90aGVyIFRoZSBzb3VyY2UgYXJyYXkgdG8gY29weSBmcm9tXHJcbiAgICAgKiBAcGFyYW0gb2Zmc2V0IFdoZXJlIHRvIHN0YXJ0IHdyaXRpbmcgdG8gaW4gdGhpcyBhcnJheVxyXG4gICAgICovXHJcbiAgICBzZXQob3RoZXI6IFQsIG9mZnNldCA9IDApOiB2b2lkIHtcclxuICAgICAgICB0aGlzLl9pbXBsLnNldChvdGhlciBhcyBuZXZlciwgb2Zmc2V0KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFRoaXMgaXMgc2ltcGx5IGByZXNpemVgLCB0aGVuIGBzZXRgLCB3aXRoIGFjY29tbW9kYXRpb24gbWFkZSBmb3IgYFR5cGVkQXJyYXlgcyBvZiBkaWZmZXJlbnQgc2l6ZXNcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIG90aGVyIFRoZSBzb3VyY2UgYXJyYXkgdGhhdCB0aGlzIGFycmF5IHdpbGwgY29weSBpbnRvIFdBU00gbWVtb3J5LiBJdCBjYW4gYmUgYW55IGtpbmQgb2YgYFR5cGVkQXJyYXlgLlxyXG4gICAgICovXHJcbiAgICBhc3NpZ24ob3RoZXI6IEFsbFR5cGVkQXJyYXlzKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3Qgb3VyTmV3Q291bnQgPSBvdGhlci5ieXRlTGVuZ3RoIC8gdGhpcy5faW1wbC5CWVRFU19QRVJfRUxFTUVOVDtcclxuICAgICAgICBpZiAoTWF0aC5mbG9vcihvdXJOZXdDb3VudCkgIT0gb3VyTmV3Q291bnQpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRBcnJheUxlbmd0aEVycm9yKG90aGVyLmJ5dGVMZW5ndGgsIHRoaXMuX2ltcGwuQllURVNfUEVSX0VMRU1FTlQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnJlc2l6ZShvdXJOZXdDb3VudCk7XHJcbiAgICAgICAgdGhpcy5zZXQobmV3IHRoaXMuVHlwZWRBcnJheShvdGhlcikpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSWRlbnRpY2FsbHkgdG8gYFR5cGVkQXJyYXkuYXRgLCBhIG5lZ2F0aXZlIGBpbmRleGAgd2lsbCBjb3VudCBiYWNrd2FyZHMgZnJvbSB0aGUgZW5kIG9mIHRoZSBhcnJheS5cclxuICAgICAqL1xyXG4gICAgYXQoaW5kZXg6IG51bWJlcik6IG51bWJlciB8IGJpZ2ludCB8IHVuZGVmaW5lZCB7IHJldHVybiB0aGlzLl9pbXBsLmF0KGluZGV4KSB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZXNpemVzIHRoaXMgYXJyYXkgaW4gV0FTTSBtZW1vcnksIGFsbG9jYXRpbmcgYXMgbmVjZXNzYXJ5LlxyXG4gICAgICogXHJcbiAgICAgKiBJdCdzIHJlY29tbWVuZGVkIHRvIGp1c3QgdXNlIGBhc3NpZ25gLCB3aGljaCBjb3BpZXMgYW4gZW50aXJlIHNvdXJjZSBhcnJheSBpbiBvbmUgc3RlcCwgYmVjYXVzZSBcclxuICAgICAqIGFzIHVzdWFsLCByZWFkaW5nIHRoZSBuZXdseSBhc3NpZ25lZCBtZW1vcnkgYmVmb3JlIHdyaXRpbmcgdG8gaXQgaXMgdW5kZWZpbmVkIGJlaGF2aW9yIGFuZCAqKndpbGwqKiBpbW1lZGlhdGVseSBzZW5kIHlvdSB0byBjcmltZSBqYWlsLlxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0gbmV3Q291bnQgVGhlIG51bWJlciBvZiBpdGVtcyBpbiB0aGlzIGFycmF5IChub3QgdGhlIHRvdGFsIHNpemUgaW4gYnl0ZXMpXHJcbiAgICAgKi9cclxuICAgIHJlc2l6ZShuZXdDb3VudDogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKG5ld0NvdW50ICE9IHRoaXMuX2N1cnJlbnRDb3VudCkge1xyXG4gICAgICAgICAgICBjb25zdCBuZXdCeXRlQ291bnQgPSBuZXdDb3VudCAqIHRoaXMuX2J5dGVzUGVyV29yZDtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX3B0cilcclxuICAgICAgICAgICAgICAgIHRoaXMuX3B0ciA9IHRoaXMuX3JlYWxsb2MhKHRoaXMuX3B0ciwgbmV3Qnl0ZUNvdW50KTtcclxuICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgdGhpcy5fcHRyID0gdGhpcy5fbWFsbG9jIShuZXdCeXRlQ291bnQpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5fdXBkYXRlVHlwZWRBcnJheUltcGwodGhpcy5fcHRyLCBuZXdDb3VudClcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZXR1cm5zIHRoZSBhZGRyZXNzIG9mIHRoaXMgYXJyYXkgKGZvciB1c2Ugd2l0aCBvdGhlciBXQVNNIGZ1bmN0aW9ucyB0aGF0IGV4cGVjdCBhIHBvaW50ZXIgdGhhdCBwb2ludHMgdG8gYW4gYXJyYXkpXHJcbiAgICAgKi9cclxuICAgIGdldCBhZGRyZXNzKCk6IG51bWJlciB8IG51bGwgeyByZXR1cm4gdGhpcy5fcHRyIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgY29uc3RydWN0b3IocHJpdmF0ZSBUeXBlZEFycmF5OiBuZXcoYnVmZmVyOiBBcnJheUJ1ZmZlckxpa2UsIGJ5dGVPZmZzZXQ/OiBudW1iZXIsIGxlbmd0aD86IG51bWJlcikgPT4gVCwgcHJvdGVjdGVkIF9pbnN0YW5jZTogSW5zdGFudGlhdGVkV2FzbSwgcHJvdGVjdGVkIF9ieXRlc1BlcldvcmQ6IG51bWJlciwgaW5pdGlhbENvdW50PzogbnVtYmVyIHwgbnVsbCkge1xyXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvdW5ib3VuZC1tZXRob2RcclxuICAgICAgICBjb25zdCB7IG1hbGxvYywgcmVhbGxvYywgZnJlZSB9ID0gX2luc3RhbmNlLmV4cG9ydHM7XHJcbiAgICAgICAgdGhpcy5fbWFsbG9jID0gbWFsbG9jO1xyXG4gICAgICAgIHRoaXMuX3JlYWxsb2MgPSByZWFsbG9jO1xyXG4gICAgICAgIHRoaXMuX2ZyZWUgPSBmcmVlO1xyXG4gICAgICAgIHRoaXMuX2N1cnJlbnRDb3VudCA9IGluaXRpYWxDb3VudCB8fCAwO1xyXG5cclxuICAgICAgICBpZiAoaW5pdGlhbENvdW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3B0ciA9IHRoaXMuX21hbGxvYyhpbml0aWFsQ291bnQgKiB0aGlzLl9ieXRlc1BlcldvcmQpO1xyXG4gICAgICAgICAgICB0aGlzLl91cGRhdGVUeXBlZEFycmF5SW1wbCh0aGlzLl9wdHIsIGluaXRpYWxDb3VudCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgICAgdGhpcy5fcHRyID0gbnVsbDtcclxuXHJcblxyXG4gICAgICAgIHRoaXMuX3VwZGF0ZVR5cGVkQXJyYXlJbXBsKHRoaXMuX3B0ciB8fCAwLCBpbml0aWFsQ291bnQgfHwgMCk7XHJcbiAgICB9XHJcblxyXG4gICAgW1N5bWJvbC5kaXNwb3NlXSgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5fcHRyKVxyXG4gICAgICAgICAgICB0aGlzLl9mcmVlISh0aGlzLl9wdHIpO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgTmF0aXZlSW50OEFycmF5IGV4dGVuZHMgTmF0aXZlVHlwZWRBcnJheTxJbnQ4QXJyYXk+IHsgY29uc3RydWN0b3IoaW5zdGFuY2U6IEluc3RhbnRpYXRlZFdhc20sIGluaXRpYWxDb3VudDogbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkgeyBzdXBlcihJbnQ4QXJyYXksIGluc3RhbmNlLCAxLCBpbml0aWFsQ291bnQpOyB9IH1cclxuZXhwb3J0IGNsYXNzIE5hdGl2ZVVpbnQ4QXJyYXkgZXh0ZW5kcyBOYXRpdmVUeXBlZEFycmF5PFVpbnQ4QXJyYXk+IHsgY29uc3RydWN0b3IoaW5zdGFuY2U6IEluc3RhbnRpYXRlZFdhc20sIGluaXRpYWxDb3VudDogbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkgeyBzdXBlcihVaW50OEFycmF5LCBpbnN0YW5jZSwgMSwgaW5pdGlhbENvdW50KTsgfSB9XHJcbmV4cG9ydCBjbGFzcyBOYXRpdmVVaW50OENsYW1wZWRBcnJheSBleHRlbmRzIE5hdGl2ZVR5cGVkQXJyYXk8VWludDhDbGFtcGVkQXJyYXk+IHsgY29uc3RydWN0b3IoaW5zdGFuY2U6IEluc3RhbnRpYXRlZFdhc20sIGluaXRpYWxDb3VudDogbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkgeyBzdXBlcihVaW50OENsYW1wZWRBcnJheSwgaW5zdGFuY2UsIDEsIGluaXRpYWxDb3VudCk7IH0gfVxyXG5cclxuZXhwb3J0IGNsYXNzIE5hdGl2ZUludDE2QXJyYXkgZXh0ZW5kcyBOYXRpdmVUeXBlZEFycmF5PEludDE2QXJyYXk+IHsgY29uc3RydWN0b3IoaW5zdGFuY2U6IEluc3RhbnRpYXRlZFdhc20sIGluaXRpYWxDb3VudDogbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkgeyBzdXBlcihJbnQxNkFycmF5LCBpbnN0YW5jZSwgMiwgaW5pdGlhbENvdW50KTsgfSB9XHJcbmV4cG9ydCBjbGFzcyBOYXRpdmVVaW50MTZBcnJheSBleHRlbmRzIE5hdGl2ZVR5cGVkQXJyYXk8VWludDE2QXJyYXk+IHsgY29uc3RydWN0b3IoaW5zdGFuY2U6IEluc3RhbnRpYXRlZFdhc20sIGluaXRpYWxDb3VudDogbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkgeyBzdXBlcihVaW50MTZBcnJheSwgaW5zdGFuY2UsIDIsIGluaXRpYWxDb3VudCk7IH0gfVxyXG5cclxuZXhwb3J0IGNsYXNzIE5hdGl2ZUludDMyQXJyYXkgZXh0ZW5kcyBOYXRpdmVUeXBlZEFycmF5PEludDMyQXJyYXk+IHsgY29uc3RydWN0b3IoaW5zdGFuY2U6IEluc3RhbnRpYXRlZFdhc20sIGluaXRpYWxDb3VudDogbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkgeyBzdXBlcihJbnQzMkFycmF5LCBpbnN0YW5jZSwgNCwgaW5pdGlhbENvdW50KTsgfSB9XHJcbmV4cG9ydCBjbGFzcyBOYXRpdmVVaW50MzJBcnJheSBleHRlbmRzIE5hdGl2ZVR5cGVkQXJyYXk8VWludDMyQXJyYXk+IHsgY29uc3RydWN0b3IoaW5zdGFuY2U6IEluc3RhbnRpYXRlZFdhc20sIGluaXRpYWxDb3VudDogbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkgeyBzdXBlcihVaW50MzJBcnJheSwgaW5zdGFuY2UsIDQsIGluaXRpYWxDb3VudCk7IH0gfVxyXG5cclxuZXhwb3J0IGNsYXNzIE5hdGl2ZUJpZ0ludDY0QXJyYXkgZXh0ZW5kcyBOYXRpdmVUeXBlZEFycmF5PEJpZ0ludDY0QXJyYXk+IHsgY29uc3RydWN0b3IoaW5zdGFuY2U6IEluc3RhbnRpYXRlZFdhc20sIGluaXRpYWxDb3VudDogbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkgeyBzdXBlcihCaWdJbnQ2NEFycmF5LCBpbnN0YW5jZSwgOCwgaW5pdGlhbENvdW50KTsgfSB9XHJcbmV4cG9ydCBjbGFzcyBOYXRpdmVCaWdVaW50NjRBcnJheSBleHRlbmRzIE5hdGl2ZVR5cGVkQXJyYXk8QmlnVWludDY0QXJyYXk+IHsgY29uc3RydWN0b3IoaW5zdGFuY2U6IEluc3RhbnRpYXRlZFdhc20sIGluaXRpYWxDb3VudDogbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkgeyBzdXBlcihCaWdVaW50NjRBcnJheSwgaW5zdGFuY2UsIDgsIGluaXRpYWxDb3VudCk7IH0gfVxyXG4iXX0=