export class InvalidArrayLengthError extends Error {
    constructor(sourceByteCount, targetItemSize) {
        super(`The array could not be assigned because the source array is ${sourceByteCount} byte${sourceByteCount == 1 ? "" : "s"} long, which is not divisible by ${targetItemSize}, the number of bytes per element in the target array.`);
    }
}
/**
 * Represents a `TypedArray` (e.g. `Int8Array`, etc.) that exists in WASM memory instead of JS memory.
 *
 * As this class is Disposable, it should be created with `using` so your program doesn't OOM.
 */
class NativeTypedArray {
    TypedArray;
    _instance;
    _bytesPerWord;
    // This is assigned in a function that's definitely called from the constructor
    _impl;
    _currentCount;
    _ptr = null;
    _malloc;
    _realloc;
    _free;
    _updateTypedArrayImpl(newAddress, newCount) {
        this._impl = new this.TypedArray(this._instance.exports.memory.buffer, newAddress, newCount);
    }
    /**
     * Like `TypedArray.set`, this does not resize the array based on the input. If you're assigning to this array from a source, be sure to call `resize` first.
     * @param other The source array to copy from
     * @param offset Where to start writing to in this array
     */
    set(other, offset = 0) {
        this._impl.set(other, offset);
    }
    /**
     * This is simply `resize`, then `set`, with accommodation made for `TypedArray`s of different sizes
     *
     * @param other The source array that this array will copy into WASM memory. It can be any kind of `TypedArray`.
     */
    assign(other) {
        const ourNewCount = other.byteLength / this._impl.BYTES_PER_ELEMENT;
        if (Math.floor(ourNewCount) != ourNewCount) {
            throw new InvalidArrayLengthError(other.byteLength, this._impl.BYTES_PER_ELEMENT);
        }
        this.resize(ourNewCount);
        this.set(new this.TypedArray(other));
    }
    /**
     * Identically to `TypedArray.at`, a negative `index` will count backwards from the end of the array.
     */
    at(index) { return this._impl.at(index); }
    /**
     * Resizes this array in WASM memory, allocating as necessary.
     *
     * It's recommended to just use `assign`, which copies an entire source array in one step, because
     * as usual, reading the newly assigned memory before writing to it is undefined behavior and **will** immediately send you to crime jail.
     *
     * @param newCount The number of items in this array (not the total size in bytes)
     */
    resize(newCount) {
        if (newCount != this._currentCount) {
            const newByteCount = newCount * this._bytesPerWord;
            if (this._ptr)
                this._ptr = this._realloc(this._ptr, newByteCount);
            else
                this._ptr = this._malloc(newByteCount);
            this._updateTypedArrayImpl(this._ptr, newCount);
        }
    }
    /**
     * Returns the address of this array (for use with other WASM functions that expect a pointer that points to an array)
     */
    get address() { return this._ptr; }
    constructor(TypedArray, _instance, _bytesPerWord, initialCount) {
        this.TypedArray = TypedArray;
        this._instance = _instance;
        this._bytesPerWord = _bytesPerWord;
        const { malloc, realloc, free } = _instance.exports;
        this._malloc = malloc;
        this._realloc = realloc;
        this._free = free;
        this._currentCount = initialCount || 0;
        if (initialCount) {
            this._ptr = this._malloc(initialCount * this._bytesPerWord);
            this._updateTypedArrayImpl(this._ptr, initialCount);
        }
        else
            this._ptr = null;
        this._updateTypedArrayImpl(this._ptr || 0, initialCount || 0);
    }
    [Symbol.dispose]() {
        if (this._ptr)
            this._free(this._ptr);
    }
}
export class NativeInt8Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(Int8Array, instance, 1, initialCount); }
}
export class NativeUint8Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(Uint8Array, instance, 1, initialCount); }
}
export class NativeUint8ClampedArray extends NativeTypedArray {
    constructor(instance, initialCount) { super(Uint8ClampedArray, instance, 1, initialCount); }
}
export class NativeInt16Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(Int16Array, instance, 2, initialCount); }
}
export class NativeUint16Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(Uint16Array, instance, 2, initialCount); }
}
export class NativeInt32Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(Int32Array, instance, 4, initialCount); }
}
export class NativeUint32Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(Uint32Array, instance, 4, initialCount); }
}
export class NativeBigInt64Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(BigInt64Array, instance, 8, initialCount); }
}
export class NativeBigUint64Array extends NativeTypedArray {
    constructor(instance, initialCount) { super(BigUint64Array, instance, 8, initialCount); }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlLWFycmF5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL25hdGl2ZS1hcnJheS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFLQSxNQUFNLE9BQU8sdUJBQXdCLFNBQVEsS0FBSztJQUM5QyxZQUFZLGVBQXVCLEVBQUUsY0FBc0I7UUFDdkQsS0FBSyxDQUFDLCtEQUErRCxlQUFlLFFBQVEsZUFBZSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLG9DQUFvQyxjQUFjLHdEQUF3RCxDQUFDLENBQUE7SUFDMU8sQ0FBQztDQUNKO0FBRUQ7Ozs7R0FJRztBQUNILE1BQWUsZ0JBQWdCO0lBcUVHO0lBQWlHO0lBQTJDO0lBbkUxSywrRUFBK0U7SUFDckUsS0FBSyxDQUFLO0lBRVosYUFBYSxDQUFTO0lBQ3RCLElBQUksR0FBNEIsSUFBSSxDQUFDO0lBQ3JDLE9BQU8sQ0FBb0M7SUFDM0MsUUFBUSxDQUFpRDtJQUN6RCxLQUFLLENBQWlDO0lBR3RDLHFCQUFxQixDQUFDLFVBQWtCLEVBQUUsUUFBZ0I7UUFDOUQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxDQUFNLENBQUM7SUFDdEcsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxHQUFHLENBQUMsS0FBUSxFQUFFLE1BQU0sR0FBRyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQXVCLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxNQUFNLENBQUMsS0FBcUI7UUFDeEIsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDO1FBQ3BFLElBQUksSUFBSSxD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dE4sTUFBTSxPQUFPLG9CQUFxQixTQUFRLGdCQUFnQztJQUFHLFlBQVksUUFBOEIsRUFBRSxZQUF1QyxJQUFJLEtBQUssQ0FBQyxjQUFjLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7Q0FBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluc3RhbnRpYXRlZFdhc2kgfSBmcm9tIFwiLi9pbnN0YW50aWF0ZWQtd2FzaS5qc1wiO1xyXG5pbXBvcnQgeyBQb2ludGVyIH0gZnJvbSBcIi4vdHlwZXMuanNcIjtcclxuXHJcbnR5cGUgQWxsVHlwZWRBcnJheXMgPSBVaW50OEFycmF5IHwgSW50OEFycmF5IHwgVWludDhDbGFtcGVkQXJyYXkgfCBVaW50MTZBcnJheSB8IEludDE2QXJyYXkgfCBVaW50MzJBcnJheSB8IEludDMyQXJyYXkgfCBCaWdJbnQ2NEFycmF5IHwgQmlnVWludDY0QXJyYXk7XHJcblxyXG5leHBvcnQgY2xhc3MgSW52YWxpZEFycmF5TGVuZ3RoRXJyb3IgZXh0ZW5kcyBFcnJvciB7XHJcbiAgICBjb25zdHJ1Y3Rvcihzb3VyY2VCeXRlQ291bnQ6IG51bWJlciwgdGFyZ2V0SXRlbVNpemU6IG51bWJlcikge1xyXG4gICAgICAgIHN1cGVyKGBUaGUgYXJyYXkgY291bGQgbm90IGJlIGFzc2lnbmVkIGJlY2F1c2UgdGhlIHNvdXJjZSBhcnJheSBpcyAke3NvdXJjZUJ5dGVDb3VudH0gYnl0ZSR7c291cmNlQnl0ZUNvdW50ID09IDEgPyBcIlwiIDogXCJzXCJ9IGxvbmcsIHdoaWNoIGlzIG5vdCBkaXZpc2libGUgYnkgJHt0YXJnZXRJdGVtU2l6ZX0sIHRoZSBudW1iZXIgb2YgYnl0ZXMgcGVyIGVsZW1lbnQgaW4gdGhlIHRhcmdldCBhcnJheS5gKVxyXG4gICAgfVxyXG59XHJcblxyXG4vKipcclxuICogUmVwcmVzZW50cyBhIGBUeXBlZEFycmF5YCAoZS5nLiBgSW50OEFycmF5YCwgZXRjLikgdGhhdCBleGlzdHMgaW4gV0FTTSBtZW1vcnkgaW5zdGVhZCBvZiBKUyBtZW1vcnkuXHJcbiAqIFxyXG4gKiBBcyB0aGlzIGNsYXNzIGlzIERpc3Bvc2FibGUsIGl0IHNob3VsZCBiZSBjcmVhdGVkIHdpdGggYHVzaW5nYCBzbyB5b3VyIHByb2dyYW0gZG9lc24ndCBPT00uXHJcbiAqL1xyXG5hYnN0cmFjdCBjbGFzcyBOYXRpdmVUeXBlZEFycmF5PFQgZXh0ZW5kcyBBbGxUeXBlZEFycmF5cz4ge1xyXG5cclxuICAgIC8vIFRoaXMgaXMgYXNzaWduZWQgaW4gYSBmdW5jdGlvbiB0aGF0J3MgZGVmaW5pdGVseSBjYWxsZWQgZnJvbSB0aGUgY29uc3RydWN0b3JcclxuICAgIHByb3RlY3RlZCBfaW1wbCE6IFQ7XHJcblxyXG4gICAgcHJpdmF0ZSBfY3VycmVudENvdW50OiBudW1iZXI7XHJcbiAgICBwcml2YXRlIF9wdHI6IFBvaW50ZXI8dW5rbm93bj4gfCBudWxsID0gbnVsbDtcclxuICAgIHByaXZhdGUgX21hbGxvYzogKChzaXplOiBudW1iZXIpID0+IG51bWJlcikgfCBudWxsO1xyXG4gICAgcHJpdmF0ZSBfcmVhbGxvYzogKChwdHI6IG51bWJlciwgc2l6ZTogbnVtYmVyKSA9PiBudW1iZXIpIHwgbnVsbDtcclxuICAgIHByaXZhdGUgX2ZyZWU6ICgocHRyOiBudW1iZXIpID0+IHZvaWQpIHwgbnVsbDtcclxuXHJcblxyXG4gICAgcHJpdmF0ZSBfdXBkYXRlVHlwZWRBcnJheUltcGwobmV3QWRkcmVzczogbnVtYmVyLCBuZXdDb3VudDogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5faW1wbCA9IG5ldyB0aGlzLlR5cGVkQXJyYXkodGhpcy5faW5zdGFuY2UuZXhwb3J0cy5tZW1vcnkuYnVmZmVyLCBuZXdBZGRyZXNzLCBuZXdDb3VudCkgYXMgVDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIExpa2UgYFR5cGVkQXJyYXkuc2V0YCwgdGhpcyBkb2VzIG5vdCByZXNpemUgdGhlIGFycmF5IGJhc2VkIG9uIHRoZSBpbnB1dC4gSWYgeW91J3JlIGFzc2lnbmluZyB0byB0aGlzIGFycmF5IGZyb20gYSBzb3VyY2UsIGJlIHN1cmUgdG8gY2FsbCBgcmVzaXplYCBmaXJzdC5cclxuICAgICAqIEBwYXJhbSBvdGhlciBUaGUgc291cmNlIGFycmF5IHRvIGNvcHkgZnJvbVxyXG4gICAgICogQHBhcmFtIG9mZnNldCBXaGVyZSB0byBzdGFydCB3cml0aW5nIHRvIGluIHRoaXMgYXJyYXlcclxuICAgICAqL1xyXG4gICAgc2V0KG90aGVyOiBULCBvZmZzZXQgPSAwKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5faW1wbC5zZXQob3RoZXIgYXMgQXJyYXlMaWtlPGFueT4sIG9mZnNldCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBUaGlzIGlzIHNpbXBseSBgcmVzaXplYCwgdGhlbiBgc2V0YCwgd2l0aCBhY2NvbW1vZGF0aW9uIG1hZGUgZm9yIGBUeXBlZEFycmF5YHMgb2YgZGlmZmVyZW50IHNpemVzXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSBvdGhlciBUaGUgc291cmNlIGFycmF5IHRoYXQgdGhpcyBhcnJheSB3aWxsIGNvcHkgaW50byBXQVNNIG1lbW9yeS4gSXQgY2FuIGJlIGFueSBraW5kIG9mIGBUeXBlZEFycmF5YC5cclxuICAgICAqL1xyXG4gICAgYXNzaWduKG90aGVyOiBBbGxUeXBlZEFycmF5cyk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IG91ck5ld0NvdW50ID0gb3RoZXIuYnl0ZUxlbmd0aCAvIHRoaXMuX2ltcGwuQllURVNfUEVSX0VMRU1FTlQ7XHJcbiAgICAgICAgaWYgKE1hdGguZmxvb3Iob3VyTmV3Q291bnQpICE9IG91ck5ld0NvdW50KSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJyYXlMZW5ndGhFcnJvcihvdGhlci5ieXRlTGVuZ3RoLCB0aGlzLl9pbXBsLkJZVEVTX1BFUl9FTEVNRU5UKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5yZXNpemUob3VyTmV3Q291bnQpO1xyXG4gICAgICAgIHRoaXMuc2V0KG5ldyB0aGlzLlR5cGVkQXJyYXkob3RoZXIpKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIElkZW50aWNhbGx5IHRvIGBUeXBlZEFycmF5LmF0YCwgYSBuZWdhdGl2ZSBgaW5kZXhgIHdpbGwgY291bnQgYmFja3dhcmRzIGZyb20gdGhlIGVuZCBvZiB0aGUgYXJyYXkuXHJcbiAgICAgKi9cclxuICAgIGF0KGluZGV4OiBudW1iZXIpOiBudW1iZXIgfCBiaWdpbnQgfCB1bmRlZmluZWQgeyByZXR1cm4gdGhpcy5faW1wbC5hdChpbmRleCkgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVzaXplcyB0aGlzIGFycmF5IGluIFdBU00gbWVtb3J5LCBhbGxvY2F0aW5nIGFzIG5lY2Vzc2FyeS5cclxuICAgICAqIFxyXG4gICAgICogSXQncyByZWNvbW1lbmRlZCB0byBqdXN0IHVzZSBgYXNzaWduYCwgd2hpY2ggY29waWVzIGFuIGVudGlyZSBzb3VyY2UgYXJyYXkgaW4gb25lIHN0ZXAsIGJlY2F1c2UgXHJcbiAgICAgKiBhcyB1c3VhbCwgcmVhZGluZyB0aGUgbmV3bHkgYXNzaWduZWQgbWVtb3J5IGJlZm9yZSB3cml0aW5nIHRvIGl0IGlzIHVuZGVmaW5lZCBiZWhhdmlvciBhbmQgKip3aWxsKiogaW1tZWRpYXRlbHkgc2VuZCB5b3UgdG8gY3JpbWUgamFpbC5cclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIG5ld0NvdW50IFRoZSBudW1iZXIgb2YgaXRlbXMgaW4gdGhpcyBhcnJheSAobm90IHRoZSB0b3RhbCBzaXplIGluIGJ5dGVzKVxyXG4gICAgICovXHJcbiAgICByZXNpemUobmV3Q291bnQ6IG51bWJlcik6IHZvaWQge1xyXG4gICAgICAgIGlmIChuZXdDb3VudCAhPSB0aGlzLl9jdXJyZW50Q291bnQpIHtcclxuICAgICAgICAgICAgY29uc3QgbmV3Qnl0ZUNvdW50ID0gbmV3Q291bnQgKiB0aGlzLl9ieXRlc1BlcldvcmQ7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9wdHIpXHJcbiAgICAgICAgICAgICAgICB0aGlzLl9wdHIgPSB0aGlzLl9yZWFsbG9jISh0aGlzLl9wdHIsIG5ld0J5dGVDb3VudCk7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHRoaXMuX3B0ciA9IHRoaXMuX21hbGxvYyEobmV3Qnl0ZUNvdW50KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVR5cGVkQXJyYXlJbXBsKHRoaXMuX3B0ciwgbmV3Q291bnQpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmV0dXJucyB0aGUgYWRkcmVzcyBvZiB0aGlzIGFycmF5IChmb3IgdXNlIHdpdGggb3RoZXIgV0FTTSBmdW5jdGlvbnMgdGhhdCBleHBlY3QgYSBwb2ludGVyIHRoYXQgcG9pbnRzIHRvIGFuIGFycmF5KVxyXG4gICAgICovXHJcbiAgICBnZXQgYWRkcmVzcygpOiBudW1iZXIgfCBudWxsIHsgcmV0dXJuIHRoaXMuX3B0ciB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKHByaXZhdGUgVHlwZWRBcnJheTogeyBuZXcoYnVmZmVyOiBBcnJheUJ1ZmZlckxpa2UsIGJ5dGVPZmZzZXQ/OiBudW1iZXIsIGxlbmd0aD86IG51bWJlcik6IFQgfSwgcHJvdGVjdGVkIF9pbnN0YW5jZTogSW5zdGFudGlhdGVkV2FzaTx7fT4sIHByb3RlY3RlZCBfYnl0ZXNQZXJXb3JkOiBudW1iZXIsIGluaXRpYWxDb3VudD86IG51bWJlciB8IG51bGwpIHtcclxuICAgICAgICBjb25zdCB7IG1hbGxvYywgcmVhbGxvYywgZnJlZSB9ID0gX2luc3RhbmNlLmV4cG9ydHM7XHJcbiAgICAgICAgdGhpcy5fbWFsbG9jID0gbWFsbG9jO1xyXG4gICAgICAgIHRoaXMuX3JlYWxsb2MgPSByZWFsbG9jO1xyXG4gICAgICAgIHRoaXMuX2ZyZWUgPSBmcmVlO1xyXG4gICAgICAgIHRoaXMuX2N1cnJlbnRDb3VudCA9IGluaXRpYWxDb3VudCB8fCAwO1xyXG5cclxuICAgICAgICBpZiAoaW5pdGlhbENvdW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3B0ciA9IHRoaXMuX21hbGxvYyEoaW5pdGlhbENvdW50ICogdGhpcy5fYnl0ZXNQZXJXb3JkKTtcclxuICAgICAgICAgICAgdGhpcy5fdXBkYXRlVHlwZWRBcnJheUltcGwodGhpcy5fcHRyLCBpbml0aWFsQ291bnQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHRoaXMuX3B0ciA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICBcclxuICAgICAgICB0aGlzLl91cGRhdGVUeXBlZEFycmF5SW1wbCh0aGlzLl9wdHIgfHwgMCwgaW5pdGlhbENvdW50IHx8IDApO1xyXG4gICAgfVxyXG5cclxuICAgIFtTeW1ib2wuZGlzcG9zZV0oKTogdm9pZCB7IFxyXG4gICAgICAgIGlmICh0aGlzLl9wdHIpIFxyXG4gICAgICAgICAgICB0aGlzLl9mcmVlISh0aGlzLl9wdHIpOyBcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIE5hdGl2ZUludDhBcnJheSBleHRlbmRzIE5hdGl2ZVR5cGVkQXJyYXk8SW50OEFycmF5PiB7IGNvbnN0cnVjdG9yKGluc3RhbmNlOiBJbnN0YW50aWF0ZWRXYXNpPHt9PiwgaW5pdGlhbENvdW50OiBudW1iZXIgfCBudWxsIHwgdW5kZWZpbmVkKSB7IHN1cGVyKEludDhBcnJheSwgaW5zdGFuY2UsIDEsIGluaXRpYWxDb3VudCk7IH0gfVxyXG5leHBvcnQgY2xhc3MgTmF0aXZlVWludDhBcnJheSBleHRlbmRzIE5hdGl2ZVR5cGVkQXJyYXk8VWludDhBcnJheT4geyBjb25zdHJ1Y3RvcihpbnN0YW5jZTogSW5zdGFudGlhdGVkV2FzaTx7fT4sIGluaXRpYWxDb3VudDogbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkgeyBzdXBlcihVaW50OEFycmF5LCBpbnN0YW5jZSwgMSwgaW5pdGlhbENvdW50KTsgfSB9XHJcbmV4cG9ydCBjbGFzcyBOYXRpdmVVaW50OENsYW1wZWRBcnJheSBleHRlbmRzIE5hdGl2ZVR5cGVkQXJyYXk8VWludDhDbGFtcGVkQXJyYXk+IHsgY29uc3RydWN0b3IoaW5zdGFuY2U6IEluc3RhbnRpYXRlZFdhc2k8e30+LCBpbml0aWFsQ291bnQ6IG51bWJlciB8IG51bGwgfCB1bmRlZmluZWQpIHsgc3VwZXIoVWludDhDbGFtcGVkQXJyYXksIGluc3RhbmNlLCAxLCBpbml0aWFsQ291bnQpOyB9IH1cclxuXHJcbmV4cG9ydCBjbGFzcyBOYXRpdmVJbnQxNkFycmF5IGV4dGVuZHMgTmF0aXZlVHlwZWRBcnJheTxJbnQxNkFycmF5PiB7IGNvbnN0cnVjdG9yKGluc3RhbmNlOiBJbnN0YW50aWF0ZWRXYXNpPHt9PiwgaW5pdGlhbENvdW50OiBudW1iZXIgfCBudWxsIHwgdW5kZWZpbmVkKSB7IHN1cGVyKEludDE2QXJyYXksIGluc3RhbmNlLCAyLCBpbml0aWFsQ291bnQpOyB9IH1cclxuZXhwb3J0IGNsYXNzIE5hdGl2ZVVpbnQxNkFycmF5IGV4dGVuZHMgTmF0aXZlVHlwZWRBcnJheTxVaW50MTZBcnJheT4geyBjb25zdHJ1Y3RvcihpbnN0YW5jZTogSW5zdGFudGlhdGVkV2FzaTx7fT4sIGluaXRpYWxDb3VudDogbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkgeyBzdXBlcihVaW50MTZBcnJheSwgaW5zdGFuY2UsIDIsIGluaXRpYWxDb3VudCk7IH0gfVxyXG5cclxuZXhwb3J0IGNsYXNzIE5hdGl2ZUludDMyQXJyYXkgZXh0ZW5kcyBOYXRpdmVUeXBlZEFycmF5PEludDMyQXJyYXk+IHsgY29uc3RydWN0b3IoaW5zdGFuY2U6IEluc3RhbnRpYXRlZFdhc2k8e30+LCBpbml0aWFsQ291bnQ6IG51bWJlciB8IG51bGwgfCB1bmRlZmluZWQpIHsgc3VwZXIoSW50MzJBcnJheSwgaW5zdGFuY2UsIDQsIGluaXRpYWxDb3VudCk7IH0gfVxyXG5leHBvcnQgY2xhc3MgTmF0aXZlVWludDMyQXJyYXkgZXh0ZW5kcyBOYXRpdmVUeXBlZEFycmF5PFVpbnQzMkFycmF5PiB7IGNvbnN0cnVjdG9yKGluc3RhbmNlOiBJbnN0YW50aWF0ZWRXYXNpPHt9PiwgaW5pdGlhbENvdW50OiBudW1iZXIgfCBudWxsIHwgdW5kZWZpbmVkKSB7IHN1cGVyKFVpbnQzMkFycmF5LCBpbnN0YW5jZSwgNCwgaW5pdGlhbENvdW50KTsgfSB9XHJcblxyXG5leHBvcnQgY2xhc3MgTmF0aXZlQmlnSW50NjRBcnJheSBleHRlbmRzIE5hdGl2ZVR5cGVkQXJyYXk8QmlnSW50NjRBcnJheT4geyBjb25zdHJ1Y3RvcihpbnN0YW5jZTogSW5zdGFudGlhdGVkV2FzaTx7fT4sIGluaXRpYWxDb3VudDogbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCkgeyBzdXBlcihCaWdJbnQ2NEFycmF5LCBpbnN0YW5jZSwgOCwgaW5pdGlhbENvdW50KTsgfSB9XHJcbmV4cG9ydCBjbGFzcyBOYXRpdmVCaWdVaW50NjRBcnJheSBleHRlbmRzIE5hdGl2ZVR5cGVkQXJyYXk8QmlnVWludDY0QXJyYXk+IHsgY29uc3RydWN0b3IoaW5zdGFuY2U6IEluc3RhbnRpYXRlZFdhc2k8e30+LCBpbml0aWFsQ291bnQ6IG51bWJlciB8IG51bGwgfCB1bmRlZmluZWQpIHsgc3VwZXIoQmlnVWludDY0QXJyYXksIGluc3RhbmNlLCA4LCBpbml0aWFsQ291bnQpOyB9IH1cclxuIl19